---
# apps/linode_helpers/roles/certbot_ssl/tasks/nginx-certbot.yml
- name: install python3-certbot-nginx
  apt:
    name: python3-certbot-nginx
    state: present

# - name: set certbot plugin
#   set_fact:
#     certbot_plugin: nginx
#     cacheable: yes

- name: set certbot params
  set_fact:
    certbot_plugin: nginx
    prefix: REQUESTS_CA_BUNDLE={{ ca_bundle | default(None) }}
    cmd: certbot --config {{ config_file }}
    cacheable: yes

- name: certbot command
  set_fact:
    certbot_cmd: '{{ prefix }} {{ cmd }}'

- name: write certbot config file
  template:
    src: templates/cli.ini.j2
    dest: '{{ config_file }}'
    owner: root
    group: root
    mode: '0644'

# get certs
- name: install live certificate
  shell: '{{ certbot_cmd }}'

# - name: installing let's encrypt certificate on subdomain provided via UDF
#   shell:
#     cmd: "certbot -n --nginx --agree-tos --redirect -d {{ subdomain }}.{{ domain }} -m {{ soa_email_address }}"
#   when: 
#     - domain is defined
#     - subdomain != 'www'

# - name: installing let's encrypt certificate on tld and default subdomain provided via UDF
#   shell: 
#     cmd: "certbot -n --nginx --agree-tos --redirect -d {{ domain }} -d {{ subdomain }}.{{ domain }} -m {{ soa_email_address }}"
#   when:
#     - domain is defined
#     - subdomain == 'www'

# - name: installing let's encrypt certificate on default domain
#   shell:
#     cmd: "certbot -n --nginx --agree-tos --redirect -d {{ default_dns }} -m {{ soa_email_address }}"
#   when: default_dns is defined